async function startSession(){try{const response=await fetch('https://api-capital.backend-capital.com/api/v1/session',{method:'POST',headers:{'X-CAP-API-KEY':'vQ5hjpmakUVD0N3N','Content-Type':'application/json',},body:JSON.stringify({identifier:'dvlpr.saleh@gmail.com',password:'Cc-0537221210',}),});if(response.ok)console.log('session started');if(!response.ok){throw new Error('Network response was not ok')}
const cst=response.headers.get('cst');const securityToken=response.headers.get('x-security-token');return{cst,securityToken}}catch(error){console.error('Error starting session:',error);throw error}}
function e(){try{const updateProductPrices=()=>{const elements=document.querySelectorAll('.wc-block-components-product-price:not([data-updated])');elements.forEach((element)=>{element.innerHTML=`<p>يتم جلب السعر...</p>`;element.setAttribute('data-updated','true')})};updateProductPrices();const observer=new MutationObserver((mutationsList)=>{for(const mutation of mutationsList){if(mutation.type==='childList'){updateProductPrices()}}});const productContainer=document.querySelector('.etheme-product-grid');if(productContainer){observer.observe(productContainer,{childList:!0})}}catch(error){console.error('Error starting session:',error)}}
function renderProductPrice(elements,livePrice_24,calculatedValue,color){elements.forEach((element)=>{const weight=parseFloat(element.getAttribute('data-product-weight'))||1;const manufacturingFees=parseFloat(element.getAttribute('data-product-manufacturing-fees'))||1;const goldCarat=parseInt(element.getAttribute('data-product-gold-carat'))||1;if(goldCarat===18){let livePrice_18=livePrice_24/1333.3;let calculatedValue1=weight*(manufacturingFees+livePrice_18)*1.15;color==='#10B981'?(calculatedValue=calculatedValue1+2):(calculatedValue=calculatedValue1-2)}else if(goldCarat===21){let livePrice_21=livePrice_24/1142.7;calculatedValue=weight*(manufacturingFees+livePrice_21)*1.15}else if(goldCarat===24){calculatedValue=livePrice_24*weight}
const displayValue=typeof calculatedValue==='number'?calculatedValue.toFixed(2):calculatedValue;element.innerHTML=`
             <style>
                /* Container for price and indicator */
                .price-indicator {
                    display: flex;
                    align-items: center;
                    font-family: 'Arial', sans-serif;
                    font-size: 1.2rem;
                
                    // justify-content: start;
                }

                /* Price text */
                .pricee {
                    font-weight: bold !important;
                    margin: 0px !important;
                  color: ${color} !important;
                }

          
                .arrow {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1rem;
                    transition: transform 0.3s ease, color 0.3s ease;
                }

            
                .up {
                    color: #10b981; 
                }

                .down {
                    color: #ef4444; 
                }

              .curencyy{
                margin-right: 2px;
                font-size : 1rem
              }

            
            </style>
            
            <div class="price-indicator">
             <span class="arrow" id="arrow">-</span>
                <span class="pricee" id="livePriceEl">${displayValue}</span>
               <span class="curencyy" id="curency">ر.س</span>
            </div>
          `;const arrowElement=element.querySelector('#arrow');if(color==='#10B981'){arrowElement.innerHTML='▲';arrowElement.classList.remove('down');arrowElement.classList.add('up')}else if(color==='#F43F5E'){arrowElement.innerHTML='▼';arrowElement.classList.remove('up');arrowElement.classList.add('down')}else{arrowElement.innerHTML='-';arrowElement.classList.remove('up','down')}})}
async function initiateWebSocketConnection(){try{let cst=localStorage.getItem('CST');let securityToken=localStorage.getItem('TOKEN');if(!cst||!securityToken){console.log('start new Session ...');const sessionData=await startSession();cst=sessionData.cst;securityToken=sessionData.securityToken;localStorage.setItem('CST',cst);localStorage.setItem('TOKEN',securityToken)}
const ws=new WebSocket('wss://api-streaming-capital.backend-capital.com/connect');ws.onopen=()=>{if(!localStorage.getItem('CST')||!localStorage.getItem('TOKEN')){console.log('no CST and TOKEN start new Session from onOpen ...')}else{console.log('CST & TOKEN is in storge');const subscriptionMessage={destination:'marketData.subscribe',correlationId:'100',cst,securityToken,payload:{epics:['GOLD']},};ws.send(JSON.stringify(subscriptionMessage));console.log('WebSocket connection opened')}};let prev=0;ws.onmessage=(event)=>{try{const data=JSON.parse(event.data);if(data.status==='OK'){const livePrice_24=(data.payload.bid*121)/1000;console.log('WebSocket message received:',livePrice_24);let calculatedValue=1;const difference=livePrice_24-(this.prev+0.001);let color=difference<0?'#F43F5E':'#10B981';this.prev=livePrice_24;const elements=document.querySelectorAll('#livePriceEl');renderProductPrice(elements,livePrice_24,calculatedValue,color)}else if(data.payload.errorCode==='error.invalid.session.token'){localStorage.removeItem('CST');localStorage.removeItem('TOKEN')}}catch(e){console.error('Error parsing WebSocket message:',e)}};ws.onerror=(error)=>{console.error('WebSocket error:',error)};ws.onclose=()=>{localStorage.removeItem('CST');localStorage.removeItem('TOKEN');console.log('WebSocket connection closed')}}catch(error){console.error('Failed to start session or establish WebSocket connection:',error)}}
document.addEventListener('DOMContentLoaded',()=>{const todayUTC=new Date();const dayOfWeekUTC=todayUTC.getUTCDay();e();if(dayOfWeekUTC!==0&&dayOfWeekUTC!==6){initiateWebSocketConnection()}else{console.log('Today (UTC) is Saturday or Sunday. Function not executed.')}});document.addEventListener('etheme_product_grid_ajax_loaded',function(){console.log('1233333333333333333333333333333333333333333333333333')})