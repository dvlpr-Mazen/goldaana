async function startSession(){try{const response=await fetch('https://api-capital.backend-capital.com/api/v1/session',{method:'POST',headers:{'X-CAP-API-KEY':'vQ5hjpmakUVD0N3N','Content-Type':'application/json',},body:JSON.stringify({identifier:'dvlpr.saleh@gmail.com',password:'Cc-0537221210',}),});if(response.ok)console.log('session started');if(!response.ok){throw new Error('Network response was not ok')}
const cst=response.headers.get('cst');const securityToken=response.headers.get('x-security-token');return{cst,securityToken}}catch(error){console.error('Error starting session:',error);throw error}}
function e(){try{const updateProductPrices=()=>{const elements=document.querySelectorAll('.wc-block-components-product-price:not([data-updated])');elements.forEach((element)=>{element.innerHTML=`<p>يتم جلب السعر...</p>`;element.setAttribute('data-updated','true')})};updateProductPrices();const observer=new MutationObserver((mutationsList)=>{for(const mutation of mutationsList){if(mutation.type==='childList'){updateProductPrices()}}});const productContainer=document.querySelector('.etheme-product-grid');if(productContainer){observer.observe(productContainer,{childList:!0})}}catch(error){console.error('Error starting session:',error)}}
function renderProductPrice(elements,livePrice_24,calculatedValue,color){elements.forEach((element)=>{const weight=parseFloat(element.getAttribute('data-product-weight'))||1;const manufacturingFees=parseFloat(element.getAttribute('data-product-manufacturing-fees'))||1;const goldCarat=parseInt(element.getAttribute('data-product-gold-carat'));console.log(goldCarat);if(goldCarat===18){const livePrice_18=livePrice_24*0.75;const value_18=weight*(manufacturingFees+livePrice_18)*1.15;calculatedValue=color==='#10B981'?value_18+2:value_18-2}else if(goldCarat===21){const livePrice_21=livePrice_24*0.875;const value_21=weight*(manufacturingFees+livePrice_21)*1.15;calculatedValue=color==='#10B981'?value_21+2:value_21-2}else if(goldCarat===24){calculatedValue=livePrice_24*weight}else{console.warn('Invalid gold carat value:',goldCarat)}
const displayValue=typeof calculatedValue==='number'?calculatedValue.toFixed(2):calculatedValue;element.innerHTML=`
             <style>
                /* Container for price and indicator */
                .price-indicator {
                    display: flex;
                    align-items: center;
                    font-family: 'Arial', sans-serif;
                    font-size: 1.2rem;
                
                    // justify-content: start;
                }

                /* Price text */
                .pricee {
                    font-weight: bold !important;
                      font-size: 1.25rem; !important;
                    margin: 0px !important;
                  color: ${color} !important;
                }

          
                .arrow {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1rem;
                    transition: transform 0.3s ease, color 0.3s ease;
                }

            
                .up {
                    color: #10b981; 
                }

                .down {
                    color: #ef4444; 
                }

              .curencyy{
                margin-right: 4px;
                font-size : 1.2rem
              }

            
            </style>
            
            <div class="price-indicator">
             <span class="arrow" id="arrow">-</span>
                <span class="pricee" id="livePriceEl">${displayValue}</span>
               <span class="curencyy" id="curency">ر.س</span>
            </div>
          `;const arrowElement=element.querySelector('#arrow');if(color==='#10B981'){arrowElement.innerHTML='▲';arrowElement.classList.remove('down');arrowElement.classList.add('up')}else if(color==='#F43F5E'){arrowElement.innerHTML='▼';arrowElement.classList.remove('up');arrowElement.classList.add('down')}else{arrowElement.innerHTML='-';arrowElement.classList.remove('up','down')}})}
let ws;async function verifySession(cst,token){try{const response=await fetch('https://api.example.com/verify-session',{method:'POST',headers:{'Content-Type':'application/json','CST':cst,'Authorization':`Bearer ${token}`,},});return response.ok}catch(error){console.error('Error verifying session:',error);return!1}}
async function initiateWebSocketConnection(){try{if(ws&&ws.readyState!==WebSocket.CLOSED){console.log('Closing existing WebSocket connection...');ws.close()}
let cst=localStorage.getItem('CST');let token=localStorage.getItem('TOKEN');if(!cst||!token){console.log('Session invalid, starting a new session...');const sessionData=await startSession();cst=sessionData.cst;token=sessionData.securityToken;localStorage.setItem('CST',cst);localStorage.setItem('TOKEN',token)}
ws=new WebSocket('wss://api-streaming-capital.backend-capital.com/connect');ws.onopen=()=>{console.log('WebSocket connection opened');if(ws.readyState===WebSocket.OPEN){console.log('(ws.readyState === WebSocket.OPEN)');const subscriptionMessage={destination:'marketData.subscribe',correlationId:'100',cst,securityToken:token,payload:{epics:['GOLD']},};ws.send(JSON.stringify(subscriptionMessage));console.log('Subscription message sent')}};ws.onmessage=(event)=>{try{const data=JSON.parse(event.data);console.log(data);if(data.status==='OK'){const livePrice_24=(data.payload.bid*121.5)/1000;console.log('WebSocket message received:',livePrice_24);let calculatedValue=0;const difference=livePrice_24-(this.prev||0);const color=difference<0?'#F43F5E':'#10B981';this.prev=livePrice_24;const elements=document.querySelectorAll('#livePriceEl');renderProductPrice(elements,livePrice_24,calculatedValue,color)}}catch(e){console.error('Error parsing WebSocket message:',e)}};ws.onerror=(error)=>{console.error('WebSocket error:',error)};ws.onclose=()=>{console.log('WebSocket connection closed, retrying in 5 seconds...');setTimeout(()=>{initiateWebSocketConnection()},5000)};window.addEventListener('beforeunload',()=>{if(ws){console.log('Closing WebSocket due to page unload...');ws.close()}})}catch(error){console.error('Failed to start session or establish WebSocket connection:',error)}}
document.addEventListener('DOMContentLoaded',()=>{const todayUTC=new Date();const dayOfWeekUTC=todayUTC.getUTCDay();e();if(dayOfWeekUTC!==0&&dayOfWeekUTC!==6){initiateWebSocketConnection()}else{console.log('Today (UTC) is Saturday or Sunday. Function not executed.')}});document.addEventListener('etheme_product_grid_ajax_loaded',function(){console.log('1233333333333333333333333333333333333333333333333333')})